<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI 健康信息调和器</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      :root {
        --bg: #f4f4f5;
        --card-bg: #ffffff;
        --fg: #1f1f1f;
        --muted: #666666;
        --border: #dddddd;
        --border-subtle: #cccccc;
        --primary: #2563eb;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0d0d0f;
          --card-bg: #1a1a1c;
          --fg: #f2f2f2;
          --muted: #aaaaaa;
          --border: #333333;
          --border-subtle: #555555;
          --primary: #3b82f6;
        }
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER */
      #header {
        width: 100%;
        max-width: 800px;
        margin: 14px auto 8px;
        position: relative;
        text-align: center;
      }

      h1 {
        margin: 0;
        line-height: 1.3;
        padding: 0 72px;
      }

      #title-text-main {
        font-size: 1.25rem;
        font-weight: 600;
        display: block;
      }

      #title-text-sub {
        font-size: 0.85rem;
        color: var(--muted);
        display: block;
      }

      #lang-toggle {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background: var(--card-bg);
        cursor: pointer;
        font-size: 0.78rem;
        color: var(--fg);
      }

      /* APP AREA — unified white block */
      #app {
        width: 100%;
        max-width: 800px;
        margin: 0 auto 0;
        background: var(--card-bg);
        border-radius: 14px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      /* SCROLLABLE CHAT HISTORY */
      #history {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      }

      /* WELCOME PAGE */
      #welcome-screen {
        max-height: 100%;
        overflow-y: auto;
        padding: 24px 20px;
        text-align: center;
        color: var(--muted);
      }

      #welcome-title {
        font-size: 1.15rem;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--fg);
      }

      #welcome-desc {
        font-size: 0.92rem;
        margin-bottom: 14px;
      }

      #example-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .example {
        background: var(--bg);
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid var(--border-subtle);
        text-align: left;
        transition: background 0.15s, transform 0.15s;
      }

      .example:hover {
        background: rgba(0, 0, 0, 0.07);
        transform: translateY(-1px);
      }

      /* MESSAGES */
      .msg {
        margin-bottom: 14px;
        line-height: 1.6;
      }

      .msg.assistant {
        background: rgba(0, 0, 0, 0.05);
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
      }

      /* DISCLAIMER inside unified white block */
      #disclaimer {
        text-align: center;
        font-size: 0.75rem;
        color: var(--muted);
        padding: 10px 12px;
        border-top: 1px solid var(--border);
        background: var(--card-bg);
        flex-shrink: 0;
      }

      /* INPUT AREA — bottom part of white block */
      #input-area {
        display: flex;
        padding: 10px;
        border-top: 1px solid var(--border);
        background: var(--card-bg);
        flex-shrink: 0;
      }

      #question {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        background: var(--card-bg);
        color: var(--fg);
        font-size: 1rem;
        resize: none;
        overflow-y: hidden;
        line-height: 1.45;
      }

      #send-btn {
        margin-left: 10px;
        padding: 0 18px;
        border-radius: 8px;
        background: var(--primary);
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 1rem;
      }

      @media (min-width: 900px) {
        #app {
          border-radius: 14px;
          box-shadow: 0 3px 14px rgba(0, 0, 0, 0.06);
        }

        #welcome-screen {
          padding: 32px 40px;
          max-height: calc(100vh - 260px);
        }
      }

      /* SOURCE CARD — clean, compact, card-style */
      .source-card {
        background: var(--card-bg);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 14px 16px;
        margin-top: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .source-card-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--fg);
      }

      .source-card-note {
        font-size: 0.82rem;
        color: var(--muted);
        line-height: 1.45;
      }

      .source-card-link {
        margin-top: 4px;
        font-size: 0.82rem;
        color: var(--primary);
        text-decoration: none;
      }

      .source-card-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <div id="header">
      <h1>
        <span id="title-text-main">AI 健康信息调和器</span>
        <span id="title-text-sub">Health Information Harmonizer</span>
      </h1>
      <button id="lang-toggle">中文 / EN</button>
    </div>

    <div id="app">
      <div id="history"></div>

      <div id="disclaimer">
        本工具用于整合、过滤和解释公开的健康信息，仅作一般性参考，不提供诊断、治疗或药物建议。
      </div>

      <div id="input-area">
        <textarea
          id="question"
          rows="1"
          placeholder="例如：网上说布洛芬会伤肾，是真的吗？"
        ></textarea>
        <button id="send-btn">发送</button>
      </div>
    </div>

    <script>
      /* LANGUAGE PACK */
      const UI_TEXT = {
        zh: {
          title_main: "AI 健康信息调和器",
          title_sub: "Health Information Harmonizer",
          disclaimer:
            "本工具用于整合、过滤和解释公开的健康信息，仅作一般性参考，不提供诊断、治疗或药物建议。",
          placeholder: "例如：网上说布洛芬会伤肾，是真的吗？",
          welcome_title: "欢迎使用 AI 健康信息调和器",
          welcome_desc:
            "你可以询问信息真伪、健康解释或风险提示，我会帮助你调和和澄清健康信息。",
          examples: [
            "网上说布洛芬会伤肾，这是真的吗？",
            "对乙酰氨基酚和布洛芬应该怎么选？",
            "感冒时能不能一起吃维C和其他药？"
          ],
          send: "发送",
          lang_button: "中文 / EN"
        },
        en: {
          title_main: "AI Health Information Harmonizer",
          title_sub: "Health Information Harmonizer",
          disclaimer:
            "This tool summarizes and clarifies public health information. It does not provide medical diagnosis or treatment.",
          placeholder: "Example: Does ibuprofen really harm the kidneys?",
          welcome_title: "Welcome to the Health Information Harmonizer",
          welcome_desc:
            "Ask me about accuracy, risks or interpretation of health information. I will help you clarify it.",
          examples: [
            "Does ibuprofen really harm the kidneys?",
            "How should I choose between acetaminophen and ibuprofen?",
            "Can I take vitamin C together with other cold medicines?"
          ],
          send: "Send",
          lang_button: "中文 / EN"
        }
      };

      let CURRENT_LANG = "zh";

      /* WELCOME PAGE RENDER */
      function renderWelcome() {
        const h = document.getElementById("history");
        h.innerHTML = `
          <div id="welcome-screen">
            <div id="welcome-title">${UI_TEXT[CURRENT_LANG].welcome_title}</div>
            <div id="welcome-desc">${UI_TEXT[CURRENT_LANG].welcome_desc}</div>
            <div id="example-list">
              ${UI_TEXT[CURRENT_LANG].examples
                .map(
                  ex => `<div class="example" data-q="${ex}">${ex}</div>`
                )
                .join("")}
            </div>
          </div>
        `;
        document.querySelectorAll(".example").forEach(e => {
          e.onclick = () => sendMessage(e.dataset.q);
        });
      }

      renderWelcome();

      /* MESSAGE SENDER WITH LOADING STATE */
      async function sendMessage(text) {
        const history = document.getElementById("history");
        const textarea = document.getElementById("question");
        const sendBtn = document.getElementById("send-btn");

        // 如果还在欢迎页，第一次提问时清空欢迎内容
        const welcome = document.getElementById("welcome-screen");
        if (welcome) {
          history.innerHTML = "";
        }

        const userMsg = document.createElement("div");
        userMsg.className = "msg user";
        userMsg.textContent = text;
        history.appendChild(userMsg);
        history.scrollTop = history.scrollHeight;

        // 加载中气泡
        const loadingMsg = document.createElement("div");
        loadingMsg.className = "msg assistant";
        loadingMsg.textContent =
          CURRENT_LANG === "zh" ? "正在整理信息…" : "Harmonizing information…";
        history.appendChild(loadingMsg);
        history.scrollTop = history.scrollHeight;

        // 禁用输入
        textarea.disabled = true;
        const originalBtnText = sendBtn.textContent;
        sendBtn.disabled = true;
        sendBtn.textContent = CURRENT_LANG === "zh" ? "处理中…" : "Working…";

        try {
          const res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: text, lang: CURRENT_LANG })
          });

          const data = await res.json();

          // 移除 loading 气泡
          history.removeChild(loadingMsg);

          const reply = document.createElement("div");
          reply.className = "msg assistant";

          reply.innerHTML =
            (typeof marked !== "undefined"
              ? marked.parse(data.answer || "(no response)")
              : (data.answer || "(no response)").replace(/\n/g, "<br>")) +
            renderSources(data.sources);

          history.appendChild(reply);
        } catch (e) {
          history.removeChild(loadingMsg);
          const err = document.createElement("div");
          err.className = "msg assistant";
          err.textContent =
            CURRENT_LANG === "zh"
              ? "请求失败，请稍后重试。"
              : "Request failed. Please try again.";
          history.appendChild(err);
        } finally {
          history.scrollTop = history.scrollHeight;
          textarea.disabled = false;
          sendBtn.disabled = false;
          sendBtn.textContent = originalBtnText;
        }
      }

      /* SEND BUTTON */
      document.getElementById("send-btn").onclick = () => {
        const q = document.getElementById("question").value.trim();
        if (!q) return;
        document.getElementById("question").value = "";
        sendMessage(q);
      };

      /* LANGUAGE SWITCH */
      document.getElementById("lang-toggle").onclick = () => {
        CURRENT_LANG = CURRENT_LANG === "zh" ? "en" : "zh";

        document.getElementById("title-text-main").textContent =
          UI_TEXT[CURRENT_LANG].title_main;
        document.getElementById("title-text-sub").textContent =
          UI_TEXT[CURRENT_LANG].title_sub;
        document.getElementById("disclaimer").textContent =
          UI_TEXT[CURRENT_LANG].disclaimer;
        document.getElementById("question").placeholder =
          UI_TEXT[CURRENT_LANG].placeholder;
        document.getElementById("send-btn").textContent =
          UI_TEXT[CURRENT_LANG].send;

        renderWelcome();
      };

      /* AUTO-EXPANDING TEXTAREA */
      const textarea = document.getElementById("question");

      textarea.addEventListener("input", () => {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
        document.getElementById("history").style.paddingBottom =
          textarea.scrollHeight + 60 + "px";
      });

      /* SOURCE CARDS RENDERING */
      function renderSources(sources) {
        if (!sources || !sources.length) return "";

        return sources
          .map(
            src => `
              <div class="source-card">
                <div class="source-card-title">${
                  src.name || "信息来源"
                }</div>
                ${
                  src.note
                    ? `<div class="source-card-note">${src.note}</div>`
                    : ""
                }
                ${
                  src.url
                    ? `<a class="source-card-link" href="${src.url}" target="_blank">查看来源</a>`
                    : ""
                }
              </div>
            `
          )
          .join("");
      }
    </script>
  </body>
</html>